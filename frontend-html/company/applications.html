<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>应聘管理 - 企业中心</title>
  <link rel="stylesheet" href="../css/style.css">
  <link rel="stylesheet" href="../css/icons.css">
  <link rel="stylesheet" href="../css/company.css">
</head>
<body>
  <nav class="navbar">
    <div class="container">
      <a href="../index.html" class="navbar-brand">就业管理系统</a>
      <div class="navbar-menu">
        <span id="companyName"></span>
        <a href="#" id="logoutBtn">退出登录</a>
      </div>
    </div>
  </nav>

  <div class="dashboard-container">
    <div class="sidebar">
      <div class="sidebar-header">
        <h2>企业中心</h2>
      </div>
      <div class="sidebar-menu">
        <a href="dashboard.html" class="menu-item">
          <span class="icon icon-dashboard"></span> 控制台
        </a>
        <a href="jobs.html" class="menu-item">
          <span class="icon icon-briefcase"></span> 职位管理
        </a>
        <a href="applications.html" class="menu-item active">
          <span class="icon icon-file"></span> 应聘管理
        </a>
        <a href="profile.html" class="menu-item">
          <span class="icon icon-user"></span> 企业信息
        </a>
      </div>
    </div>

    <div class="main-content">
      <div class="page-header">
        <h1>应聘管理</h1>
      </div>

      <div class="filter-tabs">
        <button class="active" data-status="all" onclick="filterApplications('all')">
          全部 <span class="badge">12</span>
        </button>
        <button data-status="pending" onclick="filterApplications('pending')">
          待处理 <span class="badge">5</span>
        </button>
        <button data-status="reviewed" onclick="filterApplications('reviewed')">
          已查看 <span class="badge">3</span>
        </button>
        <button data-status="interview" onclick="filterApplications('interview')">
          面试中 <span class="badge">2</span>
        </button>
        <button data-status="hired" onclick="filterApplications('hired')">
          已录用 <span class="badge">1</span>
        </button>
        <button data-status="rejected" onclick="filterApplications('rejected')">
          已拒绝 <span class="badge">1</span>
        </button>
      </div>

      <div class="content-card">
        <div id="applicationsList"></div>
      </div>
    </div>
  </div>

  <div class="modal" id="resumeModal">
    <div class="modal-content">
      <div class="modal-header">
        <h3>简历详情</h3>
        <span class="close" onclick="closeModal()">&times;</span>
      </div>
      <div class="modal-body" id="resumeContent"></div>
    </div>
  </div>

  <script src="../js/api.js"></script>
  <script src="../js/auth.js"></script>
  <script>
    let currentFilter = 'all';
    let applications = [];

    document.addEventListener('DOMContentLoaded', async () => {
      const user = getCurrentUser();
      const role = getUserRole();
      if (!user || role !== 'company') {
        window.location.href = '../login.html?role=company';
        return;
      }

      document.getElementById('companyName').textContent = user.name || user.companyName || '企业用户';
      await loadApplications();
      bindEvents();
    });

    async function loadApplications() {
      try {
        applications = [
          {
            id: 1,
            studentName: '张三',
            studentEmail: 'zhangsan@example.com',
            phone: '13800138000',
            jobTitle: 'Java开发工程师',
            jobId: 1,
            status: 'pending',
            appliedAt: '2024-12-05 10:30',
            education: '本科 - 计算机科学',
            experience: '2年',
            skills: 'Java, Spring, MySQL'
          },
          {
            id: 2,
            studentName: '李四',
            studentEmail: 'lisi@example.com',
            phone: '13900139000',
            jobTitle: '前端开发工程师',
            jobId: 2,
            status: 'reviewed',
            appliedAt: '2024-12-04 14:20',
            education: '本科 - 软件工程',
            experience: '3年',
            skills: 'Vue.js, React, TypeScript'
          },
          {
            id: 3,
            studentName: '王五',
            studentEmail: 'wangwu@example.com',
            phone: '13700137000',
            jobTitle: 'Java开发工程师',
            jobId: 1,
            status: 'interview',
            appliedAt: '2024-12-03 09:15',
            education: '硕士 - 计算机技术',
            experience: '4年',
            skills: 'Java, Spring Boot, Redis'
          }
        ];

        renderApplications();
      } catch (error) {
        console.error('加载应聘列表失败:', error);
        document.getElementById('applicationsList').innerHTML = `
          <div class="empty-state">
            <div class="icon icon-4x icon-warning"></div>
            <h3>加载失败</h3>
            <p>${error.message}</p>
          </div>
        `;
      }
    }

    function renderApplications() {
      const listEl = document.getElementById('applicationsList');
      
      let filteredApps = applications;
      if (currentFilter !== 'all') {
        filteredApps = applications.filter(app => app.status === currentFilter);
      }

      if (filteredApps.length === 0) {
        listEl.innerHTML = `
          <div class="empty-state">
            <div class="icon icon-4x icon-file"></div>
            <h3>暂无${getStatusText(currentFilter)}的应聘</h3>
            <p>等待求职者投递简历</p>
          </div>
        `;
        return;
      }

      listEl.innerHTML = filteredApps.map(app => `
        <div class="application-card">
          <div class="application-header">
            <div class="applicant-info">
              <div class="applicant-avatar">${app.studentName.charAt(0)}</div>
              <div class="applicant-details">
                <h3>${app.studentName}</h3>
                <p><span class="icon icon-email"></span> ${app.studentEmail}</p>
                <p><span class="icon icon-phone"></span> ${app.phone}</p>
              </div>
            </div>
            <span class="application-status ${app.status}">
              ${getStatusText(app.status)}
            </span>
          </div>
          
          <div class="application-info">
            <p><span class="icon icon-briefcase"></span> <strong>应聘职位：</strong>${app.jobTitle}</p>
            <p><span class="icon icon-education"></span> <strong>学历：</strong>${app.education}</p>
            <p><span class="icon icon-clock"></span> <strong>经验：</strong>${app.experience}</p>
            <p><span class="icon icon-tools"></span> <strong>技能：</strong>${app.skills}</p>
            <p><span class="icon icon-calendar"></span> <strong>投递时间：</strong>${app.appliedAt}</p>
          </div>
          
          <div class="application-actions">
            <button class="btn btn-sm btn-primary" onclick="viewResume(${app.id})">
              <span class="icon icon-eye"></span> 查看简历
            </button>
            ${app.status === 'pending' ? `
              <button class="btn btn-sm btn-success" onclick="changeStatus(${app.id}, 'reviewed')">
                <span class="icon icon-check"></span> 标记已查看
              </button>
            ` : ''}
            ${app.status === 'reviewed' ? `
              <button class="btn btn-sm btn-info" onclick="changeStatus(${app.id}, 'interview')">
                <span class="icon icon-calendar"></span> 安排面试
              </button>
            ` : ''}
            ${app.status === 'interview' ? `
              <button class="btn btn-sm btn-success" onclick="changeStatus(${app.id}, 'hired')">
                <span class="icon icon-success"></span> 录用
              </button>
            ` : ''}
            ${app.status !== 'rejected' && app.status !== 'hired' ? `
              <button class="btn btn-sm btn-danger" onclick="changeStatus(${app.id}, 'rejected')">
                <span class="icon icon-close"></span> 拒绝
              </button>
            ` : ''}
            <button class="btn btn-sm btn-outline-secondary" onclick="contactApplicant('${app.studentEmail}')">
              <span class="icon icon-email"></span> 联系候选人
            </button>
          </div>
        </div>
      `).join('');
    }

    function filterApplications(status) {
      currentFilter = status;
      
      document.querySelectorAll('.filter-tabs button').forEach(btn => {
        btn.classList.remove('active');
        if (btn.dataset.status === status) {
          btn.classList.add('active');
        }
      });
      
      renderApplications();
    }

    function getStatusText(status) {
      const statusMap = {
        all: '全部',
        pending: '待处理',
        reviewed: '已查看',
        interview: '面试中',
        hired: '已录用',
        rejected: '已拒绝'
      };
      return statusMap[status] || status;
    }

    function viewResume(id) {
      const app = applications.find(a => a.id === id);
      if (!app) return;

      document.getElementById('resumeContent').innerHTML = `
        <div style="padding: 20px;">
          <h2>${app.studentName}的简历</h2>
          <hr style="border: none; border-top: 1px solid #e0e0e0; margin: 20px 0;">
          <h3 style="color: #2c3e50; margin-top: 20px;">基本信息</h3>
          <p><strong>姓名：</strong>${app.studentName}</p>
          <p><strong>邮箱：</strong>${app.studentEmail}</p>
          <p><strong>电话：</strong>${app.phone}</p>
          <p><strong>学历：</strong>${app.education}</p>
          
          <h3 style="color: #2c3e50; margin-top: 20px;">工作经验</h3>
          <p>${app.experience}</p>
          
          <h3 style="color: #2c3e50; margin-top: 20px;">技能专长</h3>
          <p>${app.skills}</p>
          
          <h3 style="color: #2c3e50; margin-top: 20px;">应聘职位</h3>
          <p>${app.jobTitle}</p>
          
          <div style="margin-top: 30px;">
            <button class="btn btn-primary" onclick="closeModal()">关闭</button>
          </div>
        </div>
      `;
      
      document.getElementById('resumeModal').style.display = 'flex';
    }

    async function changeStatus(id, newStatus) {
      const statusText = getStatusText(newStatus);
      
      if (!confirm(`确定要将此应聘状态改为"${statusText}"吗？`)) {
        return;
      }

      try {
        const app = applications.find(a => a.id === id);
        if (app) {
          app.status = newStatus;
        }
        
        alert(`状态已更新为"${statusText}"！`);
        renderApplications();
      } catch (error) {
        console.error('更新状态失败:', error);
        alert('操作失败: ' + error.message);
      }
    }

    function contactApplicant(email) {
      window.location.href = `mailto:${email}`;
    }

    function closeModal() {
      document.getElementById('resumeModal').style.display = 'none';
    }

    function bindEvents() {
      document.getElementById('logoutBtn').addEventListener('click', (e) => {
        e.preventDefault();
        logout();
        window.location.href = '../login.html?role=company';
      });

      window.addEventListener('click', (e) => {
        if (e.target === document.getElementById('resumeModal')) {
          closeModal();
        }
      });
    }
  </script>
</body>
</html>
